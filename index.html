<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Chat with Login Screen</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style>
      * {
        box-sizing: border-box;
      }

      body {
        margin: 0;
        padding: 16px;
        font-family: "Nunito", system-ui, -apple-system, BlinkMacSystemFont,
          "Segoe UI", sans-serif;
        background: radial-gradient(
          circle at top,
          #ffe6f0 0,
          #fff9f2 30%,
          #ffeef8 80%
        );
        min-height: 100vh;
        display: flex;
        align-items: center;
        justify-content: center;
        color: #4b5563;
      }

      /* =============== LOGIN SCREEN =============== */

      .login-container {
        width: 100%;
        max-width: 360px;
        background: #fff7fb;
        border-radius: 22px;
        box-shadow: 0 18px 40px rgba(255, 182, 193, 0.4);
        border: 1px solid #ffe0f0;
        padding: 24px 22px 20px;
        position: relative;
        overflow: hidden;
      }

      .login-container::before,
      .login-container::after {
        content: "‚ù§";
        position: absolute;
        font-size: 28px;
        opacity: 0.15;
      }

      .login-container::before {
        top: 6px;
        right: 18px;
      }

      .login-container::after {
        bottom: 4px;
        left: 16px;
      }

      .login-title {
        font-size: 20px;
        font-weight: 700;
        margin-bottom: 4px;
        color: #f9739b;
        text-align: center;
      }

      .login-subtitle {
        font-size: 12px;
        color: #9ca3af;
        text-align: center;
        margin-bottom: 20px;
      }

      .login-field {
        margin-bottom: 12px;
        display: flex;
        flex-direction: column;
        gap: 4px;
      }

      .login-label {
        font-size: 12px;
        color: #9ca3af;
      }

      .login-input {
        padding: 9px 12px;
        border-radius: 999px;
        border: 1px solid #ffd1e6;
        background: #fff;
        color: #4b5563;
        outline: none;
        font-size: 14px;
        transition: box-shadow 0.18s ease, border-color 0.18s ease,
          transform 0.08s ease;
      }

      .login-input::placeholder {
        color: #c4c4c4;
      }

      .login-input:focus {
        border-color: #f9739b;
        box-shadow: 0 0 0 2px rgba(249, 115, 155, 0.18);
        transform: translateY(-1px);
      }

      .login-button {
        width: 100%;
        margin-top: 8px;
        border: none;
        border-radius: 999px;
        padding: 10px 18px;
        font-size: 14px;
        font-weight: 600;
        cursor: pointer;
        background: linear-gradient(135deg, #ff9eb5, #ffd6e8);
        color: #4b5563;
        box-shadow: 0 10px 22px rgba(255, 182, 193, 0.6);
        transition: transform 0.1s ease, box-shadow 0.1s ease, filter 0.1s ease;
      }

      .login-button:hover {
        transform: translateY(-1px);
        box-shadow: 0 12px 26px rgba(255, 182, 193, 0.8);
        filter: brightness(1.03);
      }

      .login-button:active {
        transform: translateY(0);
        box-shadow: 0 6px 12px rgba(255, 182, 193, 0.5);
      }

      .login-button:disabled {
        opacity: 0.6;
        cursor: not-allowed;
        box-shadow: none;
      }

      .login-error {
        margin-top: 8px;
        font-size: 12px;
        color: #f97316;
        min-height: 16px;
        text-align: center;
      }

      /* =============== CHAT SCREEN =============== */

      .chat-container {
        width: 100%;
        max-width: 480px;
        height: 80vh;
        max-height: 700px;
        background: #fff7fb;
        border-radius: 24px;
        box-shadow: 0 18px 40px rgba(255, 182, 193, 0.4);
        display: flex;
        flex-direction: column;
        overflow: hidden;
        border: 1px solid #ffe0f0;
        position: relative;
      }

      .chat-container::before,
      .chat-container::after {
        content: "‚ù§";
        position: absolute;
        font-size: 32px;
        opacity: 0.12;
        pointer-events: none;
      }

      .chat-container::before {
        top: 8px;
        left: 16px;
      }

      .chat-container::after {
        bottom: 12px;
        right: 22px;
      }

      .chat-header {
        padding: 12px 16px 10px;
        border-bottom: 1px solid #ffe0f0;
        display: flex;
        align-items: center;
        justify-content: space-between;
        background: linear-gradient(120deg, #ffe5f0, #fff7fb);
      }

      .chat-header-left {
        display: flex;
        flex-direction: column;
      }

      .chat-title {
        font-size: 16px;
        font-weight: 700;
        color: #f9739b;
        display: flex;
        align-items: center;
        gap: 6px;
      }

      .chat-title::before {
        content: "üíå";
        font-size: 18px;
      }

      .chat-subtitle {
        font-size: 12px;
        color: #9ca3af;
      }

      .chat-header-right {
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .status-pill {
        padding: 4px 8px;
        border-radius: 999px;
        font-size: 11px;
        display: inline-flex;
        align-items: center;
        gap: 6px;
        background: #fff;
        color: #6b7280;
        border: 1px solid #ffe0f0;
      }

      .status-dot {
        width: 8px;
        height: 8px;
        border-radius: 999px;
        background: #22c55e;
      }

      .logout-button {
        border: none;
        border-radius: 999px;
        padding: 5px 10px;
        font-size: 11px;
        font-weight: 600;
        cursor: pointer;
        background: #fff;
        color: #f9739b;
        border: 1px solid #ffd1e6;
        transition: background 0.1s ease, transform 0.08s ease,
          box-shadow 0.1s ease;
      }

      .logout-button:hover {
        background: #ffe6f1;
        transform: translateY(-1px);
        box-shadow: 0 4px 10px rgba(255, 182, 193, 0.5);
      }

      .logout-button:active {
        transform: translateY(0);
        box-shadow: none;
      }

      .chat-messages {
        flex: 1;
        padding: 14px 14px 10px;
        overflow-y: auto;
        background: radial-gradient(
          circle at top,
          #fff,
          #ffeef8 55%,
          #fff7fb 100%
        );
      }

      .message {
        margin-bottom: 12px;
        display: flex;
        flex-direction: column;
        max-width: 80%;
      }

      .message-meta {
        font-size: 11px;
        color: #9ca3af;
        margin-bottom: 2px;
      }

      .message-bubble {
        padding: 9px 12px;
        border-radius: 18px;
        font-size: 14px;
        line-height: 1.4;
        word-wrap: break-word;
        white-space: pre-wrap;
        position: relative;
        border: 1px solid transparent;
      }

      .message.self {
        margin-left: auto;
        align-items: flex-end;
      }

      .message.self .message-bubble {
        background: linear-gradient(135deg, #ff9eb5, #ffd6e8);
        color: #4b5563;
        border-color: #ffc5dc;
        border-bottom-right-radius: 6px;
      }

      .message.self .message-bubble::after {
        content: "";
        position: absolute;
        right: -4px;
        bottom: 0;
        width: 10px;
        height: 12px;
        background: radial-gradient(
          circle at 0 100%,
          #ffd6e8 75%,
          transparent 76%
        );
      }

      .message.other .message-bubble {
        background: #fff;
        border-color: #ffe0f0;
        border-bottom-left-radius: 6px;
      }

      .message.other .message-bubble::after {
        content: "";
        position: absolute;
        left: -4px;
        bottom: 0;
        width: 10px;
        height: 12px;
        background: radial-gradient(
          circle at 100% 100%,
          #fff 75%,
          transparent 76%
        );
      }

      .chat-input-area {
        border-top: 1px solid #ffe0f0;
        padding: 8px 10px 10px;
        background: #fffafc;
        display: flex;
        flex-direction: column;
        gap: 6px;
      }

      .input-row {
        display: flex;
        gap: 8px;
        align-items: center;
      }

      .chat-input {
        flex: 1;
        padding: 10px 14px;
        border-radius: 999px;
        border: 1px solid #ffd1e6;
        outline: none;
        background: #fff;
        color: #4b5563;
        font-size: 14px;
        transition: box-shadow 0.18s ease, border-color 0.18s ease,
          transform 0.08s ease;
      }

      .chat-input::placeholder {
        color: #c4c4c4;
      }

      .chat-input:focus {
        border-color: #f9739b;
        box-shadow: 0 0 0 2px rgba(249, 115, 155, 0.15);
        transform: translateY(-1px);
      }

      .send-button {
        border: none;
        border-radius: 999px;
        padding: 10px 16px;
        font-size: 14px;
        font-weight: 600;
        cursor: pointer;
        background: linear-gradient(135deg, #ff9eb5, #ffd6e8);
        color: #4b5563;
        display: inline-flex;
        align-items: center;
        gap: 6px;
        white-space: nowrap;
        box-shadow: 0 10px 22px rgba(255, 182, 193, 0.6);
        transition: transform 0.1s ease, box-shadow 0.1s ease, filter 0.1s ease;
      }

      .send-button:hover {
        transform: translateY(-1px);
        box-shadow: 0 12px 26px rgba(255, 182, 193, 0.8);
        filter: brightness(1.03);
      }

      .send-button:active {
        transform: translateY(0);
        box-shadow: 0 6px 12px rgba(255, 182, 193, 0.5);
      }

      .send-button[disabled] {
        opacity: 0.6;
        cursor: not-allowed;
        box-shadow: none;
      }

      .send-icon {
        font-size: 14px;
      }

      /* Show/hide screens (tetap sama dengan sebelumnya) */
      #login-screen {
        display: none;
      }

      #chat-screen {
        display: none;
      }
    </style>
  </head>
  <body>
    <!-- LOGIN SCREEN -->
    <div id="login-screen" class="login-container">
      <div class="login-title">Hello!</div>
      <div class="login-subtitle">Please log in to join the chat</div>

      <div class="login-field">
        <label class="login-label" for="login-username">Username</label>
        <input
          id="login-username"
          class="login-input"
          type="text"
          placeholder="Your name"
        />
      </div>
      <div class="login-field">
        <label class="login-label" for="login-password">Password</label>
        <input
          id="login-password"
          class="login-input"
          type="password"
          placeholder="Password"
        />
      </div>
      <button id="login-button" class="login-button">Login</button>
      <div id="login-error" class="login-error"></div>
    </div>

    <!-- CHAT SCREEN -->
    <div id="chat-screen" class="chat-container">
      <div class="chat-header">
        <div class="chat-header-left">
          <div class="chat-title">Hello Chat</div>
          <div class="chat-subtitle" id="chat-subtitle">Connecting‚Ä¶</div>
        </div>
        <div class="chat-header-right">
          <div class="status-pill">
            <span class="status-dot" id="status-dot"></span>
            <span id="status-text">Connecting</span>
          </div>
          <button id="logout-button" class="logout-button">Logout</button>
        </div>
      </div>

      <div class="chat-messages" id="messages"></div>

      <div class="chat-input-area">
        <div class="input-row">
          <input
            id="message-input"
            class="chat-input"
            type="text"
            placeholder="Type a message and press Enter‚Ä¶"
          />
          <button id="send-button" class="send-button">
            <span class="send-icon">‚û§</span>
            Send
          </button>
        </div>
      </div>
    </div>

    <script>
      // ===========================
      //  CONFIG ‚Äì EDIT THIS PART
      // ===========================

      const NCHAN_WS_URL =
        "http://103.31.204.154:80/sub?channel_id=dev_channel_1";
      const NCHAN_PUBLISH_URL =
        "http://103.31.204.154:80/pub?channel_id=dev_channel_1";

      // Static password
      const STATIC_PASSWORD = "90807060";

      // Nchan payload format (JSON)
      const USE_JSON_MESSAGES = true;

      // ===========================
      //  ELEMENTS & STATE
      // ===========================

      const loginScreen = document.getElementById("login-screen");
      const chatScreen = document.getElementById("chat-screen");

      const loginUsernameEl = document.getElementById("login-username");
      const loginPasswordEl = document.getElementById("login-password");
      const loginButton = document.getElementById("login-button");
      const loginErrorEl = document.getElementById("login-error");

      const logoutButton = document.getElementById("logout-button");
      const messagesEl = document.getElementById("messages");
      const inputEl = document.getElementById("message-input");
      const sendBtn = document.getElementById("send-button");
      const statusTextEl = document.getElementById("status-text");
      const statusDotEl = document.getElementById("status-dot");
      const chatSubtitleEl = document.getElementById("chat-subtitle");

      let ws = null;
      let reconnectTimeout = null;
      let connected = false;

      let currentUser = null;
      const AUTH_USER_KEY = "nchan-chat-auth-user";

      // ===========================
      //  UI SCREEN SWITCH
      // ===========================

      function showLoginScreen() {
        loginScreen.style.display = "block";
        chatScreen.style.display = "none";
        loginErrorEl.textContent = "";
        loginPasswordEl.value = "";
        loginButton.disabled = false;
        loginUsernameEl.focus();
      }

      function showChatScreen() {
        loginScreen.style.display = "none";
        chatScreen.style.display = "flex";
        inputEl.focus();
      }

      // ===========================
      //  CONNECTION STATUS
      // ===========================

      function setStatus(state, detail) {
        if (state === "connecting") {
          statusTextEl.textContent = "Connecting";
          statusDotEl.style.background = "#eab308";
          chatSubtitleEl.textContent = detail || "Connecting to server‚Ä¶";
        } else if (state === "online") {
          statusTextEl.textContent = "Online";
          statusDotEl.style.background = "#22c55e";
          chatSubtitleEl.textContent = detail || "Connected to Chatbox";
        } else {
          statusTextEl.textContent = "Offline";
          statusDotEl.style.background = "#ef4444";
          chatSubtitleEl.textContent = detail || "Disconnected ‚Äì retrying‚Ä¶";
        }
      }

      function connectWs() {
        if (
          ws &&
          (ws.readyState === WebSocket.OPEN ||
            ws.readyState === WebSocket.CONNECTING)
        ) {
          return;
        }

        setStatus("connecting");
        connected = false;

        try {
          ws = new WebSocket(NCHAN_WS_URL);
        } catch (err) {
          console.error("WebSocket init error:", err);
          setStatus("offline", "Failed to open WebSocket");
          scheduleReconnect();
          return;
        }

        ws.onopen = () => {
          connected = true;
          setStatus("online");
        };

        ws.onmessage = (event) => {
          handleIncomingMessage(event.data);
        };

        ws.onclose = (event) => {
          connected = false;
          console.warn("WebSocket closed", event);
          setStatus("offline", "Connection closed ‚Äì retrying‚Ä¶");
          scheduleReconnect();
        };

        ws.onerror = (event) => {
          console.error("WebSocket error", event);
          // onclose yang akan trigger reconnect
        };
      }

      function scheduleReconnect() {
        if (reconnectTimeout) return;
        reconnectTimeout = setTimeout(() => {
          reconnectTimeout = null;
          connectWs();
        }, 2000);
      }

      // ===========================
      //  MESSAGE HANDLING
      // ===========================

      function handleIncomingMessage(raw) {
        let payload = {
          user: "Unknown",
          text: String(raw),
          ts: Date.now(),
        };

        if (USE_JSON_MESSAGES) {
          try {
            const parsed = JSON.parse(raw);
            if (parsed && typeof parsed === "object") {
              payload.user = parsed.user || parsed.username || payload.user;
              payload.text = parsed.text || parsed.message || raw;
              payload.ts = parsed.timestamp || parsed.ts || payload.ts;
            }
          } catch (e) {
            payload.text = raw;
          }
        }

        addMessage(payload);
      }

      // ‚¨áÔ∏è fungsi baru untuk re-align semua bubble sesuai currentUser
      function refreshMessageAlignments() {
        const nodes = messagesEl.querySelectorAll(".message");
        nodes.forEach((node) => {
          const msgUser = node.dataset.user;
          if (!msgUser) return;

          if (currentUser && msgUser === currentUser) {
            node.classList.add("self");
            node.classList.remove("other");
          } else {
            node.classList.add("other");
            node.classList.remove("self");
          }
        });
      }

      function addMessage({ user, text, ts }) {
        const isSelf = currentUser && user === currentUser;

        const msgWrapper = document.createElement("div");
        msgWrapper.className = "message " + (isSelf ? "self" : "other");
        msgWrapper.dataset.user = user; // ‚¨ÖÔ∏è simpan username pengirim

        const meta = document.createElement("div");
        meta.className = "message-meta";

        const when = ts ? new Date(ts) : new Date();
        const hh = String(when.getHours()).padStart(2, "0");
        const mm = String(when.getMinutes()).padStart(2, "0");

        meta.textContent = `${user} ‚Ä¢ ${hh}:${mm}`;

        const bubble = document.createElement("div");
        bubble.className = "message-bubble";
        bubble.textContent = text;

        msgWrapper.appendChild(meta);
        msgWrapper.appendChild(bubble);
        messagesEl.appendChild(msgWrapper);

        messagesEl.scrollTop = messagesEl.scrollHeight;
      }

      async function sendMessage() {
        if (!currentUser) {
          alert("Silakan login dulu.");
          return;
        }

        const text = inputEl.value.trim();
        if (!text) return;

        const user = currentUser;
        const ts = Date.now();

        const body = USE_JSON_MESSAGES
          ? JSON.stringify({ user, text, timestamp: ts })
          : text;

        // Tidak render lokal dulu, tunggu echo dari WS (hindari double bubble)
        inputEl.value = "";
        inputEl.focus();

        sendBtn.disabled = true;
        try {
          const res = await fetch(NCHAN_PUBLISH_URL, {
            method: "POST",
            headers: {
              "Content-Type": USE_JSON_MESSAGES
                ? "application/json"
                : "text/plain",
            },
            body,
          });

          if (!res.ok) {
            console.error("Publish failed:", res.status, res.statusText);
          }
        } catch (err) {
          console.error("Publish error:", err);
        } finally {
          sendBtn.disabled = false;
        }
      }

      // ===========================
      //  AUTH LOGIC
      // ===========================

      function doLogin() {
        const username = loginUsernameEl.value.trim();
        const password = loginPasswordEl.value;

        loginErrorEl.textContent = "";

        if (!username) {
          loginErrorEl.textContent = "Username tidak boleh kosong.";
          return;
        }

        if (password !== STATIC_PASSWORD) {
          loginErrorEl.textContent = "Password salah.";
          return;
        }

        // sukses login
        currentUser = username;
        localStorage.setItem(AUTH_USER_KEY, username);
        showChatScreen();
        refreshMessageAlignments(); // ‚¨ÖÔ∏è history yang username-nya sama langsung pindah ke kanan
      }

      function doLogout() {
        currentUser = null;
        localStorage.removeItem(AUTH_USER_KEY);
        refreshMessageAlignments(); // ‚¨ÖÔ∏è semua balik ke kiri
        showLoginScreen();
      }

      function restoreAuthFromStorage() {
        const saved = localStorage.getItem(AUTH_USER_KEY);
        if (saved) {
          currentUser = saved;
          showChatScreen();
          refreshMessageAlignments(); // ‚¨ÖÔ∏è kalau reload & server kirim history
        } else {
          showLoginScreen();
        }
      }

      // ===========================
      //  EVENT WIRING
      // ===========================

      loginButton.addEventListener("click", () => {
        doLogin();
      });

      loginPasswordEl.addEventListener("keydown", (e) => {
        if (e.key === "Enter") {
          e.preventDefault();
          doLogin();
        }
      });

      loginUsernameEl.addEventListener("keydown", (e) => {
        if (e.key === "Enter") {
          e.preventDefault();
          loginPasswordEl.focus();
        }
      });

      logoutButton.addEventListener("click", () => {
        doLogout();
      });

      sendBtn.addEventListener("click", () => sendMessage());

      inputEl.addEventListener("keydown", (e) => {
        if (e.key === "Enter" && !e.shiftKey) {
          e.preventDefault();
          sendMessage();
        }
      });

      // ===========================
      //  INIT
      // ===========================

      window.addEventListener("load", () => {
        restoreAuthFromStorage(); // kalau mau selalu mulai dari login, clear localStorage AUTH_USER_KEY
        connectWs();
      });
    </script>
  </body>
</html>
